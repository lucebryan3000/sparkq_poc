<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>SparkQ</title>
  <script src="/ui-cache-buster.js"></script>
  <script>
    (function() {
      const env = window.__SPARKQ_ENV__ || 'dev';
      const buildId = window.__SPARKQ_BUILD_ID__ || window.__BUILD_ID__ || 'dev';
      window.__BUILD_ID__ = buildId;
      const isDevLike = env === 'dev' || env === 'test';
      const cacheBuster = isDevLike ? (window.__SPARKQ_CACHE_BUSTER__ || 'dev') : '';
      const versionQuery = cacheBuster ? `?v=${cacheBuster}` : '';
      const stylesheet = document.createElement('link');
      stylesheet.rel = 'stylesheet';
      stylesheet.href = `/ui/style.css${versionQuery}`;
      document.head.appendChild(stylesheet);

      const assets = [
        "/ui/dist/app-core.js", // defines globals (API/Utils/Pages) and deferred init hook
        "/ui/dist/ui-utils.js",
        "/ui/dist/quick-add.js",
        "/ui/dist/dashboard.js",
        "/ui/dist/queues.js",
        "/ui/dist/config.js",
        "/ui/dist/scripts.js",
      ].map((src) => `${src}${versionQuery}`);

      const loadSequentially = (paths) => {
        const target = document.body || document.head || document.documentElement;
        if (!target) return Promise.resolve();
        return paths.reduce(
          (chain, path) =>
            chain.then(
              () =>
                new Promise((resolve) => {
                  const script = document.createElement('script');
                  script.src = path;
                  script.async = false;
                  script.onload = () => resolve();
                  script.onerror = (err) => {
                    console.error('Failed to load UI asset', path, err);
                    resolve();
                  };
                  target.appendChild(script);
                }),
            ),
          Promise.resolve(),
        );
      };

      const startLoading = () =>
        loadSequentially(assets)
          .then(() => {
            if (typeof window.__SPARKQ_RUN_APP === 'function') {
              window.__SPARKQ_RUN_APP();
            }
          })
          .catch((err) => console.error('Failed to load UI assets', err));

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', startLoading);
      } else {
        startLoading();
      }
    })();
  </script>
  <noscript><link rel="stylesheet" href="/ui/style.css"></noscript>
</head>
<body>
  <header class='app-header'>
    <div class='header-left'>
      <button type='button' class='navbar-brand' id='navbar-brand-btn' aria-label='Go to dashboard' title='Go to dashboard'>
        <span class='brand-mark'>‚ö°</span>
        <span class='brand-text'>SparkQueue</span>
      </button>
    </div>
    <div class='header-right'>
      <span id="build-id" class="build-chip"></span>
      <div class="nav-actions">
        <button type='button' class='icon-button' id='settings-nav-btn' aria-label='Settings' title='Open settings'>‚öôÔ∏è</button>
        <button type='button' class='icon-button' id='theme-toggle-btn' title='Toggle dark/light mode' aria-label='Toggle theme'>üåô</button>
      </div>
    </div>
  </header>

  <main id='app' class='container'>
    <div id='dashboard-page' class='page-content'></div>
    <div id='settings-page' class='page-content'></div>
  </main>

  <div id='breadcrumbs' class='breadcrumbs'></div>

  <script>
    (function() {
      const el = document.getElementById('build-id');
      const buildId = window.__SPARKQ_BUILD_ID__ || window.__BUILD_ID__;
      if (el) {
        if (buildId) {
          el.textContent = `UI v${buildId}`;
          el.style.display = 'inline-flex';
        } else {
          el.style.display = 'none';
        }
      }
    })();
  </script>
</body>
</html>
